<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Darwin: PatchMatchGraph Project</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="drwn.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Darwin
   &#160;<span id="projectnumber">1.10(beta)</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">PatchMatchGraph Project </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This project implements algorithms based on the PatchMatchGraph data structure described in Gould and Zhang (ECCV 2012), which extends the PatchMatch algorithm of Barnes et al., (SIGGRAPH, 2009; ECCV 2010). The project is part of the <b>Darwin</b> software package. Installation instructions and addtional documentation can be found at <a href="http://drwn.anu.edu.au">http://drwn.anu.edu.au</a>.</p>
<dl class="section note"><dt>Note</dt><dd>The implementation provided here is an improved version of the algorithm that was used to report results in Gould and Zhang (ECCV 2012). Specifically, this version incorporates the following changes: <ul>
<li>image pyramids are integral to the patchMatchGraph rather that being externally generated </li>
<li>local and propagation moves search across adjacent pyramid levels </li>
<li>the random search move samples patches from adjacent pyramid levels</li>
</ul>
</dd>
<dd>
Robustness and efficiency changes were also made.</dd></dl>
<p>The sample application <code>patchMatchDemo</code> demonstrates the PatchMatchGraph construction on two images. The following command line will run the code on two images <code>imgA.jpg</code> and <code>imgB.jpg</code> and visualize the matches: </p><div class="fragment"><div class="line">../../bin/patchMatchDemo -x -profile -verbose -m 100 \</div><div class="line">    -<span class="keyword">set</span> drwnPatchMatch patchWidth 8 -<span class="keyword">set</span> drwnPatchMatch patchHeight 8 \</div><div class="line">    imgA.jpg imgB.jpg</div></div><!-- fragment --><p>The following shows an example visualization from the algorithm where the left column shows the two images being matched, the middle column shows the quality of the matches at each pixel location (blue is better), and the right column shows a reconstruction of each image using patches copied from the other image.</p>
<div class="image">
<img src="patchMatchDemoScreenshot.jpg" alt="patchMatchDemoScreenshot.jpg"/>
</div>
<p>A more ellaborate example for building a PatchMatchGraph over multiple images and then using this graph for label transfer is described below.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="classdrwnPatchMatchGraph.html" title="Each image maintains a W-by-H-by-K array of match records referencing the (approximate) best K matche...">drwnPatchMatchGraph</a>, <a class="el" href="classdrwnPatchMatchGraphLearner.html" title="Learns a PatchMatchGraph by iteratively performing search moves over the space of matches...">drwnPatchMatchGraphLearner</a></dd></dl>
<h1><a class="anchor" id="drwnProjPatchMatchLearn"></a>
Building a PatchMatchGraph</h1>
<p>These instructions describe how to build a PatchMatchGraph over a given set of images. We will use the example of the Polo dataset, but the steps can easily be adapted to any dataset. The graphs can be quite large so make sure you run on a machine with plenty of memory.</p>
<p>First we will set up a few environment variables: </p><div class="fragment"><div class="line"><span class="keyword">set</span> BIN_DIR = <span class="stringliteral">&quot;${DARWIN}/bin/&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">set</span> IMAGE_LIST = <span class="stringliteral">&quot;baseNames.txt&quot;</span></div><div class="line"><span class="keyword">set</span> CONFIG = <span class="stringliteral">&quot;poloConfig.xml&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">set</span> DATASET = <span class="stringliteral">&quot;pmPolo&quot;</span></div><div class="line"><span class="keyword">set</span> DATADIR = <span class="stringliteral">&quot;data/images/&quot;</span></div></div><!-- fragment --><p> where <code>BIN_DIR</code> is set to the executables directory, <code>IMAGE_LIST</code> contains the list of image basenames on which the graph will be built, <code>CONFIG</code> contains some configuration parameters, <code>DATA_SET</code> contains the name that will be used to save the PatchMatchGraph and <code>DATA_DIR</code> points to the directory containing the images.</p>
<p>A typical configuration file (<code>poloConfig.xml</code>) may look like: </p><div class="fragment"><div class="line">&lt;<a class="code" href="namespacedrwn.html">drwn</a>&gt;</div><div class="line"> &lt;drwnPatchMatch&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;maxImageSize&quot;</span> value=<span class="stringliteral">&quot;160&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;maxPyramidLevels&quot;</span> value=<span class="stringliteral">&quot;8&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;patchWidth&quot;</span> value=<span class="stringliteral">&quot;8&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;patchHeight&quot;</span> value=<span class="stringliteral">&quot;8&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;K&quot;</span> value=<span class="stringliteral">&quot;10&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;decayRate&quot;</span> value=<span class="stringliteral">&quot;0.0&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;fwdEnrichment&quot;</span> value=<span class="stringliteral">&quot;10&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;allowHFlips&quot;</span> value=<span class="stringliteral">&quot;true&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;allowVFlips&quot;</span> value=<span class="stringliteral">&quot;false&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;localSearch&quot;</span> value=<span class="stringliteral">&quot;true&quot;</span> /&gt;</div><div class="line">   &lt;option name=<span class="stringliteral">&quot;randomExhaustive&quot;</span> value=<span class="stringliteral">&quot;false&quot;</span> /&gt;</div><div class="line"> &lt;/drwnPatchMatch&gt;</div><div class="line"></div><div class="line"> &lt;<a class="code" href="classdrwnCodeProfiler.html">drwnCodeProfiler</a> enabled=<span class="stringliteral">&quot;true&quot;</span> /&gt;</div><div class="line"> &lt;<a class="code" href="classdrwnLogger.html">drwnLogger</a> logLevel=<span class="stringliteral">&quot;VERBOSE&quot;</span> logFile=<span class="stringliteral">&quot;polo.log&quot;</span> /&gt;</div><div class="line">&lt;/<a class="code" href="namespacedrwn.html">drwn</a>&gt;</div></div><!-- fragment --><p>Note that the configuration parameters can also be set on the command line via the <code>-set</code> <code>drwnPatchMatch</code> argument (see <a class="el" href="group__drwnBase.html#drwnConfigManagerDoc">Configuration Manager</a>). For example, adding </p><div class="fragment"><div class="line">-<span class="keyword">set</span> drwnPatchMatch maxImageSize 80</div></div><!-- fragment --><p> to the command line (after the <code>-config</code> argument) would override the <code>maxImageSize</code> option in the XML file.</p>
<p>The following command line will construct a PatchMatchGraph and save it to three files <code>${DATASET}</code>.meta, <code>${DATASET}</code>.index and <code>${DATASET}</code>.data: </p><div class="fragment"><div class="line">${BIN_DIR}/buildPatchMatchGraph -config ${CONFIG} \</div><div class="line">    -d ${DATADIR} -e .jpg -m 50 -o ${DATASET} ${IMAGE_LIST}</div></div><!-- fragment --><p>You can control how the graph is constructed by modifying the various options in the XML configuration file. You can also prevent subsets of images from matching between each other by using equivalence classes. For example, providing the <code>-eqv</code> <code>${EVAL_LIST}</code> command line option to <code>buildPatchMatchGraph</code> will create an equivalence class containing all images in the file <code>${EVAL_LIST}</code>. No edges in the PatchMatchGraph will be created between these images. Multiple equivalence classes can be defined with additional <code>-eqv</code> flags, e.g., <code>-eqv</code> <code>${EVAL_LIST}</code> <code>-eqv</code> -p ${TRAIN_LIST}.</p>
<p>For loading a saved PatchMatchGraph into Matlab see the mexLoadPatchMatchGraph application in <a class="el" href="drwnProjMatlab.html">Matlab Interfaces</a>.</p>
<h1><a class="anchor" id="drwnProjPatchMatchLabelTransfer"></a>
Using a PatchMatchGraph for Label Transfer</h1>
<p>The PatchMatchGraph constructed above can be used for semantic segmentation by transfering labels from matched patches to the image under test. The code makes use of the <a class="el" href="drwnProjMultiSeg.html">Multi-class Image Segmentation</a> infrastructure for visualizing and scoring results so you will need to include the class definitions in the configuration file. For the Polo dataset this is: </p><div class="fragment"><div class="line">&lt;<a class="code" href="classdrwnMultiSegConfig.html">drwnMultiSegConfig</a>&gt;</div><div class="line">  &lt;!-- data options --&gt;</div><div class="line">  &lt;option name=<span class="stringliteral">&quot;baseDir&quot;</span> value=<span class="stringliteral">&quot;./&quot;</span> /&gt;</div><div class="line">  &lt;option name=<span class="stringliteral">&quot;imgDir&quot;</span> value=<span class="stringliteral">&quot;data/images/&quot;</span> /&gt;</div><div class="line">  &lt;option name=<span class="stringliteral">&quot;lblDir&quot;</span> value=<span class="stringliteral">&quot;data/labels/&quot;</span> /&gt;</div><div class="line">  &lt;option name=<span class="stringliteral">&quot;cacheDir&quot;</span> value=<span class="stringliteral">&quot;cached/&quot;</span> /&gt;</div><div class="line">  &lt;option name=<span class="stringliteral">&quot;modelsDir&quot;</span> value=<span class="stringliteral">&quot;models/&quot;</span> /&gt;</div><div class="line">  &lt;option name=<span class="stringliteral">&quot;outputDir&quot;</span> value=<span class="stringliteral">&quot;output/&quot;</span> /&gt;</div><div class="line"></div><div class="line">  &lt;option name=<span class="stringliteral">&quot;imgExt&quot;</span> value=<span class="stringliteral">&quot;.jpg&quot;</span> /&gt;</div><div class="line">  &lt;option name=<span class="stringliteral">&quot;lblExt&quot;</span> value=<span class="stringliteral">&quot;.txt&quot;</span> /&gt;</div><div class="line"></div><div class="line">  &lt;option name=<span class="stringliteral">&quot;useCache&quot;</span> value=<span class="stringliteral">&quot;true&quot;</span> /&gt;</div><div class="line"></div><div class="line">  &lt;!-- region definitions --&gt;</div><div class="line">  &lt;regionDefinitions&gt;</div><div class="line">    &lt;region <span class="keywordtype">id</span>=<span class="stringliteral">&quot;-1&quot;</span> name=<span class="stringliteral">&quot;void&quot;</span> color=<span class="stringliteral">&quot;0 0 0&quot;</span>/&gt;</div><div class="line">    &lt;region <span class="keywordtype">id</span>=<span class="stringliteral">&quot;0&quot;</span> name=<span class="stringliteral">&quot;grass&quot;</span> color=<span class="stringliteral">&quot;0 128 0&quot;</span>/&gt;</div><div class="line">    &lt;region <span class="keywordtype">id</span>=<span class="stringliteral">&quot;1&quot;</span> name=<span class="stringliteral">&quot;ground&quot;</span> color=<span class="stringliteral">&quot;64 0 0&quot;</span>/&gt;</div><div class="line">    &lt;region <span class="keywordtype">id</span>=<span class="stringliteral">&quot;2&quot;</span> name=<span class="stringliteral">&quot;horse&quot;</span> color=<span class="stringliteral">&quot;128 192 128&quot;</span>/&gt;</div><div class="line">    &lt;region <span class="keywordtype">id</span>=<span class="stringliteral">&quot;3&quot;</span> name=<span class="stringliteral">&quot;person&quot;</span> color=<span class="stringliteral">&quot;128 64 0&quot;</span>/&gt;</div><div class="line">    &lt;region <span class="keywordtype">id</span>=<span class="stringliteral">&quot;4&quot;</span> name=<span class="stringliteral">&quot;sky&quot;</span> color=<span class="stringliteral">&quot;128 128 128&quot;</span>/&gt;</div><div class="line">    &lt;region <span class="keywordtype">id</span>=<span class="stringliteral">&quot;5&quot;</span> name=<span class="stringliteral">&quot;tree&quot;</span> color=<span class="stringliteral">&quot;128 128 0&quot;</span>/&gt;</div><div class="line">  &lt;/regionDefinitions&gt;</div><div class="line">&lt;/<a class="code" href="classdrwnMultiSegConfig.html">drwnMultiSegConfig</a>&gt;</div></div><!-- fragment --><p>Configuration files for the Polo, MSRC and Stanford Background datasets are included in the project directory, <code>${DARWIN}/projects/patchMatch</code>.</p>
<p>The <code>patchMatchLabelTransfer</code> application implements label transfer. Results can be generated and evaluated using: </p><div class="fragment"><div class="line">mkdir -p output</div><div class="line"></div><div class="line">${BIN_DIR}/patchMatchLabelTransfer -config ${CONFIG} \</div><div class="line">    -outLabels .pm.txt -outImages .pm.png ${DATASET} ${IMAGE_LIST}</div><div class="line"></div><div class="line">${BIN_DIR}/scorePixelLabels -config ${CONFIG} -confusion \</div><div class="line">    -inLabels .pm.txt ${IMAGE_LIST}</div></div><!-- fragment --><p>Since the code is run on the entire dataset (and the images were not broken up into equivalence classes) the results can be interpreted as leave-one-out cross-validation (i.e., each image is labeled using the rest of the dataset as training data). Using these instructions you should be able to achieve the following results on the Polo, Stanford Background and MSRC datasets:</p>
<center> <table border="1px" style="border-color:#cccccc; background-color: #f5f5f5; border-collapse:collapse;">
<tr>
<td><b>Dataset</b></td><td><b>Images</b></td><td><b>Patches</b> </td><td><b>Memory</b></td><td><b>Build Time</b></td><td><b>Accuracy</b>  </td></tr>
<tr>
<td>6-Class Polo</td><td>317</td><td>9601972 </td><td>4.9GB</td><td>0:54</td><td>89.0  </td></tr>
<tr>
<td>8-Class Stanford</td><td>715</td><td>22566965 </td><td>11GB</td><td>2:28</td><td>71.1  </td></tr>
<tr>
<td>21-Class MSRC</td><td>591</td><td>17050254 </td><td>8.4GB</td><td>1:42</td><td>68.5  </td></tr>
</table>
</center><p>With an equivalence class defined for the test set (and evaluation on the test set images only) the following results should be achieved:</p>
<center> <table border="1px" style="border-color:#cccccc; background-color: #f5f5f5; border-collapse:collapse;">
<tr>
<td><b>Dataset</b></td><td><b>Images</b></td><td><b>Test Images</b></td><td><b>Patches</b> </td><td><b>Memory</b></td><td><b>Build Time</b></td><td><b>Accuracy</b>  </td></tr>
<tr>
<td>6-Class Polo</td><td>317</td><td>237</td><td>9601972 </td><td>4.9GB</td><td>0:44</td><td>86.7  </td></tr>
<tr>
<td>8-Class Stanford</td><td>715</td><td>143</td><td>22566965 </td><td>11GB</td><td>2:14</td><td>69.6  </td></tr>
<tr>
<td>21-Class MSRC</td><td>591</td><td>256</td><td>17050254 </td><td>8.4GB</td><td>1:34</td><td>64.9  </td></tr>
</table>
</center><p> (Note that these differ slightly from Gould and Zhang (ECCV 2012)).</p>
<p>The <code>labelTransferPipeline.py</code> script runs through the above procedure using the Stanford background dataset.</p>
<h1><a class="anchor" id="drwnProjPatchMatchRef"></a>
References</h1>
<ul>
<li>Barnes, C., Shechtman, E., Finkelstein, A., Goldman, D.B., "PatchMatch: A randomized correspondence algorithm for structural
image editing." In SIGGRAPH, 2009.</li>
</ul>
<ul>
<li>Barnes, C., Shechtman, E., Goldman, D.B., Finkelstein, A., "The
generalized PatchMatch correspondence algorithm." In ECCV, 2010.</li>
</ul>
<ul>
<li>Barnes, C., "PatchMatch: A Fast Randomized Matching Algorithm
with Application to Image and Video." PhD Thesis, 2011.</li>
</ul>
<ul>
<li>S. Gould and Y. Zhang, "PatchMatchGraph: Building a Graph of
Dense Patch Correspondences for Label Transfer." In ECCV, 2012. </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed May 7 2025 09:52:24 for Darwin by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
